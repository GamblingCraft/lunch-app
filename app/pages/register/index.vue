<template>
  <div class="min-h-screen bg-gradient-to-br from-gray-50 to-gray-100 flex items-center justify-center p-4">
    <div class="bg-white rounded-2xl shadow-medium overflow-hidden w-full max-w-md border border-gray-200">
      <div class="h-2 bg-accent-500"></div>
      
      <div class="p-8">
        <div class="text-center mb-8">
          <div class="inline-flex items-center justify-center w-16 h-16 bg-gradient-to-br from-accent-50 to-white rounded-2xl mb-4 border border-gray-200">
            <svg class="w-8 h-8 text-accent-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
            </svg>
          </div>
          <h1 class="text-2xl font-bold text-gray-800 mb-2">–ó–∞–≤–µ—Ä—à–∏—Ç–µ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é</h1>
          <p class="text-gray-600">–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤–∞—à–∏ –¥–∞–Ω–Ω—ã–µ</p>
        </div>

        <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ Telegram –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ -->
        <div v-if="telegramUser" class="mb-6 p-4 bg-blue-50 rounded-lg border border-blue-200">
          <p class="text-sm font-medium text-blue-700 mb-1">–í–∞—à Telegram –∞–∫–∫–∞—É–Ω—Ç:</p>
          <p class="text-blue-600">{{ telegramUser.first_name }} {{ telegramUser.last_name }}</p>
          <p v-if="telegramUser.username" class="text-sm text-blue-500">@{{ telegramUser.username }}</p>
          <p class="text-xs text-gray-500 mt-1">ID: {{ telegramUser.id }}</p>
        </div>

        <form @submit.prevent="completeRegistration" class="space-y-6">
          <!-- –§–ò–û -->
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">
              –§–ò–û –ø–æ–ª–Ω–æ—Å—Ç—å—é *
            </label>
            <input
              v-model="form.fio"
              type="text"
              placeholder="–ò–≤–∞–Ω–æ–≤ –ò–≤–∞–Ω –ò–≤–∞–Ω–æ–≤–∏—á"
              required
              class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-accent-500 focus:border-accent-500 transition-colors bg-white outline-none"
            />
          </div>

          <!-- –û—Ç–¥–µ–ª -->
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">
              –û—Ç–¥–µ–ª *
            </label>
            <select
              v-model="form.department"
              required
              class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-accent-500 focus:border-accent-500 transition-colors bg-white outline-none"
            >
              <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –æ—Ç–¥–µ–ª</option>
              <option value="–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ü–∏—è">–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ü–∏—è</option>
              <option value="–û—Ç–¥–µ–ª —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏">–û—Ç–¥–µ–ª —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏</option>
              <option value="–û—Ç–¥–µ–ª —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è">–û—Ç–¥–µ–ª —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è</option>
              <option value="–û—Ç–¥–µ–ª –¥–∏–∑–∞–π–Ω–∞">–û—Ç–¥–µ–ª –¥–∏–∑–∞–π–Ω–∞</option>
              <option value="–û—Ç–¥–µ–ª –º–∞—Ä–∫–µ—Ç–∏–Ω–≥–∞">–û—Ç–¥–µ–ª –º–∞—Ä–∫–µ—Ç–∏–Ω–≥–∞</option>
              <option value="–°–∫–ª–∞–¥">–°–∫–ª–∞–¥</option>
              <option value="–û—Ç–¥–µ–ª –ø—Ä–æ–¥–∞–∂">–û—Ç–¥–µ–ª –ø—Ä–æ–¥–∞–∂</option>
              <option value="–û—Ç–¥–µ–ª –ø–æ–¥–¥–µ—Ä–∂–∫–∏">–û—Ç–¥–µ–ª –ø–æ–¥–¥–µ—Ä–∂–∫–∏</option>
              <option value="–õ–æ–≥–∏—Å—Ç–∏–∫–∞">–õ–æ–≥–∏—Å—Ç–∏–∫–∞</option>
              <option value="–ë—É—Ö–≥–∞–ª—Ç–µ—Ä–∏—è">–ë—É—Ö–≥–∞–ª—Ç–µ—Ä–∏—è</option>
              <option value="IT">IT</option>
              <option value="HR">HR</option>
              <option value="–ü—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–æ">–ü—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–æ</option>
            </select>
          </div>

          <button
            type="submit"
            :disabled="!isFormValid || loading"
            class="w-full py-3 px-4 rounded-lg font-medium text-white transition-all duration-200 bg-accent-500 hover:bg-accent-600 focus:ring-2 focus:ring-accent-500 focus:ring-offset-2 disabled:bg-gray-300 disabled:text-gray-500 disabled:cursor-not-allowed flex items-center justify-center"
          >
            <svg v-if="loading" class="animate-spin -ml-1 mr-2 h-4 w-4 text-white" fill="none" viewBox="0 0 24 24">
              <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
              <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            {{ loading ? '–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...' : '–ó–∞–≤–µ—Ä—à–∏—Ç—å —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é' }}
          </button>
        </form>

        <!-- –ö–Ω–æ–ø–∫–∞ –Ω–∞–∑–∞–¥ -->
        <button
          @click="goBackToAuth"
          class="w-full mt-4 text-gray-600 hover:text-gray-800 py-2 text-sm"
        >
          ‚Üê –ù–∞–∑–∞–¥ –∫ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
        </button>
      </div>
    </div>
  </div>
</template>

<script setup>
import { ref, computed, onMounted } from 'vue'
import { useRouter } from '#app'

const router = useRouter()
const isClient = typeof window !== 'undefined'

const telegramUser = ref(null)
const form = ref({
  fio: '',
  department: ''
})
const loading = ref(false)

const isFormValid = computed(() => {
  return form.value.fio.trim().length > 0 && 
         form.value.department.length > 0
})

const goBackToAuth = () => {
  // –û—á–∏—â–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
  if (isClient) {
    localStorage.removeItem('telegram_register_data')
  }
  router.push('/auth')
}

const completeRegistration = async () => {
  if (!isFormValid.value || loading.value) return
  
  loading.value = true

  if (!telegramUser.value) {
    alert('–û—à–∏–±–∫–∞: –¥–∞–Ω–Ω—ã–µ Telegram –Ω–µ –Ω–∞–π–¥–µ–Ω—ã')
    loading.value = false
    return
  }

  // –ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è API
  const userData = {
    telegram_id: Number(telegramUser.value.id),
    first_name: telegramUser.value.first_name || '',
    last_name: telegramUser.value.last_name || '',
    username: telegramUser.value.username || '',
    photo_url: telegramUser.value.photo_url || '',
    fio: form.value.fio.trim(),
    department: form.value.department,
    is_admin: false // –ù–æ–≤—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –Ω–µ –∞–¥–º–∏–Ω—ã
  }

  try {
    console.log('üì§ –û—Ç–ø—Ä–∞–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏:', userData)
    
    // –ò—Å–ø–æ–ª—å–∑—É–µ–º –≤–∞—à —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π API endpoint
    const response = await $fetch('/api/users/register', {
      method: 'POST',
      body: userData
    })
    
    console.log('‚úÖ –†–µ–∑—É–ª—å—Ç–∞—Ç —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏:', response)

    if (response.success) {
      // –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ localStorage
      localStorage.setItem('user', JSON.stringify(response.user))
      localStorage.setItem('is_admin', 'false')
      localStorage.setItem('user_id', response.user.id.toString())
      
      // –û—á–∏—â–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
      localStorage.removeItem('telegram_register_data')
      localStorage.removeItem('telegram_auth_data')
      
      alert('üéâ –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∞!')
      
      // –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ–º –≤ –∫–∞–±–∏–Ω–µ—Ç
      setTimeout(() => {
        router.push('/cabinet')
      }, 500)
    } else {
      alert('‚ùå –û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏: ' + (response.message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'))
      loading.value = false
    }
  } catch (error) {
    console.error('üí• –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è:', error)
    alert('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –¥–∞–Ω–Ω—ã—Ö. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.')
    loading.value = false
  }
}

onMounted(() => {
  if (!isClient) return

  console.log('üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–∞–Ω–Ω—ã—Ö —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏...')
  
  // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ Telegram –¥–ª—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
  const telegramRegisterData = localStorage.getItem('telegram_register_data')
  
  console.log('üì¶ –î–∞–Ω–Ω—ã–µ –∏–∑ localStorage:', telegramRegisterData)
  
  if (!telegramRegisterData) {
    console.error('‚ùå –î–∞–Ω–Ω—ã–µ –¥–ª—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã')
    alert('–î–∞–Ω–Ω—ã–µ –¥–ª—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∞–≤—Ç–æ—Ä–∏–∑—É–π—Ç–µ—Å—å —á–µ—Ä–µ–∑ Telegram.')
    router.push('/auth')
    return
  }

  try {
    const data = JSON.parse(telegramRegisterData)
    console.log('üìã –ü–∞—Ä—Å–∏–Ω–≥ –¥–∞–Ω–Ω—ã—Ö:', data)
    
    telegramUser.value = {
      id: data.id,
      first_name: data.first_name || '',
      last_name: data.last_name || '',
      username: data.username || '',
      photo_url: data.photo_url || ''
    }
    
    console.log('üë§ Telegram –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å:', telegramUser.value)
    
    // –ê–≤—Ç–æ–∑–∞–ø–æ–ª–Ω—è–µ–º –§–ò–û –∏–∑ Telegram –¥–∞–Ω–Ω—ã—Ö
    if (telegramUser.value.first_name || telegramUser.value.last_name) {
      const telegramName = `${telegramUser.value.first_name || ''} ${telegramUser.value.last_name || ''}`.trim()
      if (telegramName && !form.value.fio) {
        form.value.fio = telegramName
        console.log('‚úèÔ∏è –ê–≤—Ç–æ–∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –§–ò–û:', telegramName)
      }
    }
  } catch (error) {
    console.error('‚ùå –û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ Telegram –¥–∞–Ω–Ω—ã—Ö:', error)
    alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏')
    router.push('/auth')
  }
})
</script>